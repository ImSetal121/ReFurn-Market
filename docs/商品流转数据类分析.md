# 商品流转数据类分析

## 概述

本文档详细分析了 ReFlip 平台中商品在买家、卖家、仓库三个主体间流转时产生的数据类。根据商品类型（寄卖/自提）和流转方向，会产生不同的数据记录。

## 寄卖模式流转数据类

### 1. 卖家 → 仓库（上门取货）

#### 1.1 寄卖物流记录表 (`rf_product_auction_logistics`)
记录商品从卖家到仓库的运输信息

```sql
CREATE TABLE rf_product_auction_logistics (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,                    -- 商品ID
    product_sell_record_id BIGINT,                -- 销售记录ID（此时为空）
    pickup_address TEXT NOT NULL,                 -- 取货地址（卖家地址）
    warehouse_id BIGINT,                          -- 目标仓库ID
    warehouse_address TEXT,                       -- 仓库地址
    is_use_logistics_service BOOLEAN,             -- 是否使用物流服务
    appointment_pickup_date DATE,                 -- 预约取件日期
    appointment_pickup_time_period VARCHAR(20),   -- 预约取件时间段
    internal_logistics_task_id BIGINT,            -- 内部物流任务ID
    external_logistics_service_name VARCHAR(100), -- 外部物流服务商
    external_logistics_order_number VARCHAR(100), -- 外部物流单号
    status VARCHAR(50),                           -- 状态：PENDING_PICKUP, PENDING_WAREHOUSING, WAREHOUSED
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

#### 1.2 内部物流任务表 (`rf_internal_logistics_task`)
记录平台内部物流任务

```sql
CREATE TABLE rf_internal_logistics_task (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,
    product_consignment_record_id BIGINT,         -- 寄卖记录ID
    task_type VARCHAR(50),                        -- 任务类型：PICKUP_SERVICE
    logistics_user_id BIGINT,                     -- 物流人员ID
    source_address TEXT,                          -- 源地址（卖家地址）
    target_address TEXT,                          -- 目标地址（仓库地址）
    source_address_image_url_json TEXT,           -- 取货时货件图片
    target_address_image_url_json TEXT,           -- 入库时货件图片
    contact_phone VARCHAR(20),                    -- 联系电话
    logistics_cost DECIMAL(10,2),                 -- 物流费用
    status VARCHAR(50),                           -- 状态：PENDING_ACCEPT, PENDING_PICKUP, PENDING_RECEIPT, COMPLETED
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

### 2. 仓库入库阶段

#### 2.1 仓库入库申请表 (`rf_warehouse_in_apply`)
记录商品入库申请和审核

```sql
CREATE TABLE rf_warehouse_in_apply (
    id BIGSERIAL PRIMARY KEY,
    warehouse_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    product_consignment_record_id BIGINT,         -- 寄卖记录ID
    source VARCHAR(50),                           -- 货件来源：PICKUP_SERVICE
    apply_quantity INTEGER DEFAULT 1,             -- 申请入库数量
    apply_time TIMESTAMP,                         -- 申请入库时间
    product_image_url_json TEXT,                  -- 货件图片集
    audit_result VARCHAR(50),                     -- 审核结果：APPROVED_WAREHOUSING, REJECTED_WAREHOUSING
    audit_detail TEXT,                            -- 审核详细说明
    status VARCHAR(50),                           -- 状态：PENDING_APPROVAL, APPROVED
    warehouse_in_id BIGINT,                       -- 入库记录ID
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

#### 2.2 仓库入库表 (`rf_warehouse_in`)
记录实际入库信息

```sql
CREATE TABLE rf_warehouse_in (
    id BIGSERIAL PRIMARY KEY,
    warehouse_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    in_quantity INTEGER DEFAULT 1,                -- 入库数量
    in_time TIMESTAMP,                            -- 入库时间
    stock_position VARCHAR(255),                  -- 存放位置
    product_image_url_json TEXT,                  -- 入库时货件图片
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

#### 2.3 仓库库存表 (`rf_warehouse_stock`)
记录仓库库存信息

```sql
CREATE TABLE rf_warehouse_stock (
    id BIGSERIAL PRIMARY KEY,
    warehouse_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    stock_quantity INTEGER,                       -- 库存数量
    stock_position VARCHAR(255),                  -- 存放位置
    warehouse_in_apply_id BIGINT,                -- 入库申请ID
    warehouse_in_id BIGINT,                      -- 入库记录ID
    in_time TIMESTAMP,                           -- 入库时间
    in_type VARCHAR(50),                         -- 入库类型：PICKUP_SERVICE
    status VARCHAR(50),                          -- 状态：IN_STOCK, OUT_OF_STOCK
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

### 3. 仓库 → 买家（发货）

#### 3.1 商品仓库发货记录表 (`rf_product_warehouse_shipment`)
记录仓库发货信息

```sql
CREATE TABLE rf_product_warehouse_shipment (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,
    product_sell_record_id BIGINT NOT NULL,       -- 销售记录ID
    warehouse_id BIGINT NOT NULL,
    warehouse_address TEXT,                       -- 仓库地址
    buyer_receipt_address TEXT,                   -- 买家收货地址
    shipment_time TIMESTAMP,                      -- 发货时间
    internal_logistics_task_id BIGINT,            -- 内部物流任务ID
    shipment_image_url_json TEXT,                 -- 发货时货件图片
    status VARCHAR(50),                           -- 状态：PENDING_OUTBOUND, PENDING_RECEIPT, SIGNED
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

#### 3.2 仓库出库表 (`rf_warehouse_out`)
记录仓库出库信息

```sql
CREATE TABLE rf_warehouse_out (
    id BIGSERIAL PRIMARY KEY,
    warehouse_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    product_sell_record_id BIGINT NOT NULL,       -- 销售记录ID
    stock_position VARCHAR(255),                  -- 存放位置
    out_quantity INTEGER,                         -- 出库数量
    out_time TIMESTAMP,                           -- 出库时间
    product_image_url_json TEXT,                  -- 出库时货件图片
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

## 自提模式流转数据类

### 1. 卖家 → 买家（直接配送）

#### 1.1 商品自提物流记录表 (`rf_product_self_pickup_logistics`)
记录自提商品配送信息

```sql
CREATE TABLE rf_product_self_pickup_logistics (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,
    product_sell_record_id BIGINT NOT NULL,       -- 销售记录ID
    pickup_address TEXT,                          -- 取货地址（卖家地址）
    buyer_receipt_address TEXT,                   -- 买家收货地址
    external_logistics_service_name VARCHAR(100), -- 外部物流服务商
    external_logistics_order_number VARCHAR(100), -- 外部物流单号
    status VARCHAR(50),                           -- 状态：SHIPPED, SIGNED
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

#### 1.2 非寄卖信息记录表 (`rf_product_non_consignment_info`)
记录非寄卖商品配送信息

```sql
CREATE TABLE rf_product_non_consignment_info (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,
    seller_id BIGINT NOT NULL,                    -- 卖家ID
    delivery_method VARCHAR(50),                  -- 送达方式：BUYER_SELF_PICKUP, SELLER_SELF_SHIPPING
    pickup_address TEXT,                          -- 取货地址
    pickup_address_detail TEXT,                   -- 取货地址详细
    buyer_receipt_address TEXT,                   -- 收货地址
    buyer_receipt_address_detail TEXT,            -- 收货地址详细
    appointment_pickup_date DATE,                 -- 预约取货日期
    appointment_pickup_time_period VARCHAR(20),   -- 预约取货时间段
    status VARCHAR(50),                           -- 状态：INCOMPLETE, COMPLETED
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

## 退货流转数据类

### 1. 寄卖商品退货

#### 1.1 商品退货记录表 (`rf_product_return_record`)
记录寄卖商品退货的完整信息

```sql
CREATE TABLE rf_product_return_record (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,                    -- 商品ID
    product_sell_record_id BIGINT NOT NULL,       -- 销售记录ID
    return_reason_type VARCHAR(50),               -- 退货原因类型
    return_reason_detail TEXT,                    -- 退货原因详细说明
    seller_accept_return BOOLEAN,                 -- 卖方是否接受退货
    seller_opinion_detail TEXT,                   -- 卖方意见详细说明
    audit_result VARCHAR(50),                     -- 审核结果：REJECTED, APPROVED
    freight_bearer VARCHAR(50),                   -- 运费承担方：SELLER, BUYER, PLATFORM
    freight_bearer_user_id BIGINT,                -- 运费承担用户ID
    need_compensate_product BOOLEAN,              -- 是否需要赔偿商品
    compensation_bearer VARCHAR(50),              -- 赔偿承担方：SELLER, BUYER, PLATFORM
    compensation_bearer_user_id BIGINT,           -- 赔偿承担用户ID
    is_auction BOOLEAN,                           -- 是否寄卖：TRUE
    is_use_logistics_service BOOLEAN,             -- 是否使用物流服务
    pickup_address TEXT,                          -- 退货取件地址（买家地址）
    appointment_pickup_time TIMESTAMP,            -- 预约取件时间
    internal_logistics_task_id BIGINT,            -- 内部物流任务ID
    external_logistics_service_name VARCHAR(100), -- 外部物流服务商
    external_logistics_order_number VARCHAR(100), -- 外部物流单号
    status VARCHAR(50),                           -- 状态：RETURN_INITIATED, RETURNED_TO_WAREHOUSE, RETURNED_TO_WAREHOUSE_CONFIRMED
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

#### 1.2 商品退回卖家记录表 (`rf_product_return_to_seller`)
记录寄卖商品从仓库退回卖家的信息

```sql
CREATE TABLE rf_product_return_to_seller (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,                    -- 商品ID
    product_sell_record_id BIGINT NOT NULL,       -- 销售记录ID
    warehouse_id BIGINT,                          -- 仓库ID
    warehouse_address TEXT,                       -- 仓库地址
    seller_receipt_address TEXT,                  -- 卖家收货地址
    internal_logistics_task_id BIGINT,            -- 内部物流任务ID
    shipment_time TIMESTAMP,                      -- 发货时间
    shipment_image_url_json TEXT,                 -- 发货时货件图片
    status VARCHAR(50),                           -- 状态：PENDING_SHIPMENT, SHIPPED, RECEIVED
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

### 2. 自提商品退货

#### 2.1 商品退货记录表 (`rf_product_return_record`)
自提商品退货使用同一张表，但字段值不同

```sql
-- 自提商品退货的关键字段差异：
-- is_auction: FALSE
-- status: RETURN_INITIATED, RETURNED_TO_SELLER, RETURN_COMPLETED
-- internal_logistics_task_id: 可能为空（直接退回卖家）
```

## 通用流转数据类

### 1. 商品销售记录表
**商品出售记录表** (`rf_product_sell_record`)

```sql
CREATE TABLE rf_product_sell_record (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,                    -- 商品ID
    seller_user_id BIGINT NOT NULL,               -- 卖家用户ID
    buyer_user_id BIGINT NOT NULL,                -- 买家用户ID
    final_product_price DECIMAL(10,2),            -- 最终商品价格
    is_auction BOOLEAN,                           -- 是否寄卖
    internal_logistics_task_id BIGINT,            -- 内部物流任务ID
    product_warehouse_shipment_id BIGINT,         -- 仓库发货记录ID
    is_self_pickup BOOLEAN,                       -- 是否自提
    product_self_pickup_logistics_id BIGINT,      -- 自提物流ID
    buyer_receipt_image_url_json TEXT,            -- 买家收货时图片集
    seller_return_image_url_json TEXT,            -- 退货到卖家时图片集
    status VARCHAR(50),                           -- 状态：PENDING_SHIPMENT, PENDING_RECEIPT, DELIVERED, CONFIRMED, RETURN_INITIATED, RETURNED_TO_WAREHOUSE, RETURNED_TO_SELLER
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

### 2. 内部物流任务表
**内部物流任务表** (`rf_internal_logistics_task`)

```sql
CREATE TABLE rf_internal_logistics_task (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL,
    product_sell_record_id BIGINT,                -- 销售记录ID
    product_consignment_record_id BIGINT,         -- 寄卖记录ID
    product_return_record_id BIGINT,              -- 退货记录ID
    product_return_to_seller_record_id BIGINT,   -- 退回卖家记录ID
    task_type VARCHAR(50),                        -- 任务类型：PICKUP_SERVICE, WAREHOUSE_SHIPMENT, PRODUCT_RETURN, RETURN_TO_SELLER
    logistics_user_id BIGINT,                     -- 物流人员ID
    source_address TEXT,                          -- 源地址
    target_address TEXT,                          -- 目标地址
    source_address_image_url_json TEXT,           -- 源地址时货件图片
    target_address_image_url_json TEXT,           -- 目标地址时货件图片
    contact_phone VARCHAR(20),                    -- 联系电话
    logistics_cost DECIMAL(10,2),                 -- 物流费用
    status VARCHAR(50),                           -- 状态：PENDING_ACCEPT, PENDING_PICKUP, PENDING_RECEIPT, COMPLETED, CANCELLED
    create_time TIMESTAMP,
    update_time TIMESTAMP
);
```

## 数据流转总结

### 寄卖模式流转产生的数据类：
1. `rf_product_auction_logistics` - 寄卖物流记录
2. `rf_internal_logistics_task` - 内部物流任务
3. `rf_warehouse_in_apply` - 仓库入库申请
4. `rf_warehouse_in` - 仓库入库记录
5. `rf_warehouse_stock` - 仓库库存记录
6. `rf_product_warehouse_shipment` - 仓库发货记录
7. `rf_warehouse_out` - 仓库出库记录
8. `rf_product_return_record` - 退货记录（寄卖）
9. `rf_product_return_to_seller` - 退回卖家记录

### 自提模式流转产生的数据类：
1. `rf_product_self_pickup_logistics` - 自提物流记录
2. `rf_product_non_consignment_info` - 非寄卖信息记录
3. `rf_product_return_record` - 退货记录（自提）
4. `rf_internal_logistics_task` - 内部物流任务（可选）

### 通用流转数据类：
1. `rf_product_sell_record` - 商品销售记录
2. `rf_internal_logistics_task` - 内部物流任务

## 关键特点

### 1. 状态流转追踪
- 每个运输阶段都有明确的状态标识
- 支持状态回滚和异常处理
- 完整的操作时间记录

### 2. 图片证据链
- **取货时图片**：`source_address_image_url_json`
- **入库时图片**：`target_address_image_url_json`
- **发货时图片**：`shipment_image_url_json`
- **收货时图片**：`buyer_receipt_image_url_json`

### 3. 地址信息管理
- **源地址**：取货地址（卖家地址）
- **目标地址**：收货地址（买家地址）或仓库地址
- **地址验证**：通过 Google Maps API 验证地址有效性

### 4. 物流成本控制
- **内部物流任务**：平台自有物流人员
- **外部物流服务**：第三方物流公司
- **成本分摊**：运费承担方明确标识

### 5. 异常处理机制
- **任务取消**：支持物流任务取消
- **状态回滚**：支持状态回退
- **异常记录**：完整的异常处理日志

## 重要说明

### 自提商品退货不会入库
根据代码分析，自提商品（非寄卖商品）的退货流程：
- **状态直接设置为** `RETURNED_TO_SELLER`
- **不会创建物流任务**（代码中没有调用 `createReturnLogisticsTask`）
- **不会经过仓库**（直接退回卖家）
- **不会产生入库申请**（`rf_warehouse_in_apply`）
- **不会产生入库记录**（`rf_warehouse_in`）
- **不会产生库存记录**（`rf_warehouse_stock`）

---
